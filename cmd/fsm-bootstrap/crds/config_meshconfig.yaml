# Custom Resource Definition (CRD) for FSM's configuration specification.
#
# Copyright Flomesh Service Mesh authors.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: meshconfigs.config.flomesh.io
  labels:
    app.kubernetes.io/name : "flomesh.io"
spec:
  group: config.flomesh.io
  scope: Namespaced
  names:
    kind: MeshConfig
    listKind: MeshConfigList
    shortNames:
      - meshconfig
    singular: meshconfig
    plural: meshconfigs
  conversion:
    strategy: None
  versions:
    - name: v1alpha2
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                clusterSet:
                  description: Configuration for cluster
                  type: object
                  properties:
                    properties:
                      description: Configuration for cluster
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            description: Name defines the name of cluster property.
                            type: string
                          value:
                            description: Value defines the name of cluster property.
                            type: string
                sidecar:
                  description: Configuration for sidecar
                  type: object
                  properties:
                    enablePrivilegedInitContainer:
                      description: Enables privileged init containers for pods in mesh. When false, init containers only have NET_ADMIN.
                      type: boolean
                    logLevel:
                      description: Sets the logging verbosity of proxy sidecar, only applicable to newly created pods joining the mesh.
                      type: string
                      enum:
                        - trace
                        - debug
                        - info
                        - warning
                        - warn
                        - error
                        - critical
                        - off
                    maxDataPlaneConnections:
                      description: Max allowed data plane sidecar connections
                      type: integer
                    sidecarClass:
                      description: Class of the sidecar
                      type: string
                      enum:
                        - pipy
                    sidecarImage:
                      description: Image for the sidecar
                      type: string
                    initContainerImage:
                      description: Image for the init container
                      type: string
                    sidecarDrivers:
                      description: Drivers of sidecars supported by fsm
                      type: array
                      items:
                        type: object
                        required:
                          - sidecarName
                        properties:
                          sidecarName:
                            description: Name for the sidecar
                            type: string
                          sidecarImage:
                            description: Image for the sidecar
                            type: string
                          initContainerImage:
                            description: Image for the init container
                            type: string
                          proxyServerPort:
                            description: Remote destination port on which the Discovery Service listens for new connections from Sidecars.
                            type: integer
                            minimum: 1
                            maximum: 65535
                          sidecarDisabledMTLS:
                            description: Disabled mTLS
                            type: boolean
                    resources:
                      type: object
                      properties:
                        limits:
                          description: "Limits describes the maximum amount of compute resources allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/"
                          type: object
                          additionalProperties: true
                        requests:
                          description: "Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/"
                          type: object
                          additionalProperties: true
                    configResyncInterval:
                      description: Resync interval for regular proxy broadcast updates
                      type: string
                    tlsMinProtocolVersion:
                      description: The minimum TLS protocol version that the sidecar supports. Valid TLS protocol versions are TLS_AUTO, TLSv1_0, TLSv1_1, TLSv1_2 and TLSv1_3.
                      type: string
                      enum:
                        - TLS_AUTO
                        - TLSv1_0
                        - TLSv1_1
                        - TLSv1_2
                        - TLSv1_3
                      default: TLSv1_2
                    tlsMaxProtocolVersion:
                      description: The maximum TLS protocol version that the sidecar supports. Valid TLS protocol versions are TLS_AUTO, TLSv1_0, TLSv1_1, TLSv1_2 and TLSv1_3.
                      type: string
                      enum:
                        - TLS_AUTO
                        - TLSv1_0
                        - TLSv1_1
                        - TLSv1_2
                        - TLSv1_3
                      default: TLSv1_3
                    cipherSuites:
                      description: A list of ciphers that listener supports when negotiating TLS 1.0-1.2. This setting has no effect when negotiating TLS 1.3. For valid cipher names, see the latest OpenSSL ciphers manual page. E.g. https://www.openssl.org/docs/man1.1.1/apps/ciphers.html.
                      type: array
                      items:
                        type: string
                    ecdhCurves:
                      description: A list of ECDH curves that TLS connection supports. If not specified, the curves are [X25519, P-256] for non-FIPS build and P-256 for builds using BoringSSL FIPS.
                      type: array
                      items:
                        type: string
                    localProxyMode:
                      description: Sets the destination ip address the sidecar proxy will use when connecting to the backend application. Acceptable values are [Localhost, PodIP]. The default value is Localhost
                      type: string
                      enum:
                        - Localhost
                        - PodIP
                      default: Localhost
                    localDNSProxy:
                      description: LocalDNSProxy improves the performance of your computer by caching the responses coming from your DNS servers
                      type: object
                      properties:
                        enable:
                          description: Enables local DNS proxy for the mesh.
                          type: boolean
                        primaryUpstreamDNSServerIPAddr:
                          description: Primary upstream DNS server for local DNS Proxy.
                          type: string
                        secondaryUpstreamDNSServerIPAddr:
                          description: Secondary upstream DNS server for local DNS Proxy.
                          type: string
                repoServer:
                  description: Configuration for RepoServer
                  type: object
                  required:
                    - ipaddr
                    - codebase
                  properties:
                    ipaddr:
                      description: IPAddr of the RepoServer.
                      type: string
                    codebase:
                      description: Codebase is the folder used by fsmController.
                      type: string
                traffic:
                  description: Configuration for traffic management
                  type: object
                  properties:
                    interceptionMode:
                      description: Traffic interception mode in the mesh
                      type: string
                      enum:
                        - iptables
                        - ebpf
                        - none
                    enableEgress:
                      description: Enables egress in the mesh
                      type: boolean
                    outboundIPRangeExclusionList:
                      description: Global list of IP address ranges to exclude from outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: string
                        pattern: ((?:\d{1,3}\.){3}\d{1,3})\/(\d{1,2})$
                    outboundIPRangeInclusionList:
                      description: Global list of IP address ranges to include for outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: string
                        pattern: ((?:\d{1,3}\.){3}\d{1,3})\/(\d{1,2})$
                    outboundPortExclusionList:
                      description: Global list of ports to exclude from outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: integer
                        minimum: 1
                        maximum: 65535
                    inboundPortExclusionList:
                      description: Global list of ports to exclude from inbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: integer
                        minimum: 1
                        maximum: 65535
                    networkInterfaceExclusionList:
                      description: NetworkInterfaceExclusionList defines a global list of network interface names to exclude from inbound and outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: string
                    enablePermissiveTrafficPolicyMode:
                      description: True for allowing traffic to flow between client and service pods within the mesh without SMI traffic policies, i.e. no traffic policy enforcement in the mesh. If set to false, enables deny-all traffic policy in mesh i.e. an SMI Traffic Target is necessary for services to communicate.
                      type: boolean
                    inboundExternalAuthorization:
                      description: Configures external authorization for inbound and ingress connections.
                      type: object
                      properties:
                        enable:
                          description: Enables/disables the inbound external authorization policy if present.
                          type: boolean
                        address:
                          description: Target destination endpoint that will handle external authorization.
                          type: string
                        port:
                          description: Remote destination port for the external authorization endpoint.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        statPrefix:
                          description: String prefix for inbound external authorization related metrics.
                          type: string
                          default: "inboundExtAuthz"
                        timeout:
                          description: Defines the timeout to consider for the remote endpoint to reply in time.
                          type: string
                          default: "1s"
                        failureModeAllow:
                          description: Allows specifying if traffic should succeed or fail if the external authorization endpoint fails to respond.
                          type: boolean
                observability:
                  description: Configuration for observing the service mesh, including metrics, logs, tracing etc,.
                  type: object
                  properties:
                    fsmLogLevel:
                      description: Allows setting FSM control plane log level at runtime
                      type: string
                    enableDebugServer:
                      description: Enables a debug endpoint on the fsm-controller pod to list information regarding the mesh such as proxy connections, certificates, and SMI policies.
                      type: boolean
                    tracing:
                      description: Configuration for distributed tracing
                      type: object
                      properties:
                        enable:
                          description: Enables Jaeger tracing for the mesh.
                          type: boolean
                        port:
                          description: Port on which tracing is enabled.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        address:
                          description: Address of Jaeger tracing deployment, if tracing is enabled.
                          type: string
                        endpoint:
                          description: Endpoint for tracing data, if tracing is enabled.
                          type: string
                        sampledFraction:
                          description: SampledFraction defines the sampled fraction.
                          type: string
                    remoteLogging:
                      description: Configuration for remote logging
                      type: object
                      properties:
                        enable:
                          description: Enables remote logging for the mesh.
                          type: boolean
                        port:
                          description: Port on which remote logging is enabled.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        address:
                          description: Address of remote logging deployment, if remote logging is enabled.
                          type: string
                        endpoint:
                          description: Endpoint for tracing data, if remote logging is enabled.
                          type: string
                        authorization:
                          description: Authorization for remote logging service, if remote logging is enabled.
                          type: string
                        sampledFraction:
                          description: SampledFraction defines the sampled fraction.
                          type: string
                certificate:
                  description: Configuration for certificate management
                  type: object
                  required:
                    - serviceCertValidityDuration
                    - certKeyBitSize
                  properties:
                    serviceCertValidityDuration:
                      description: Sets the service certificate validity duration, represented as a sequence of decimal numbers each with optional fraction and a unit suffix.
                      type: string
                    certKeyBitSize:
                      description: Sets the certificate key bit size for data plane certificates.
                      type: integer
                    ingressGateway:
                      description: Configuration for the ingress gateway's certificate
                      type: object
                      required:
                        - subjectAltNames
                        - validityDuration
                        - secret
                      properties:
                        subjectAltNames:
                          description: Subject Alternative Names secured by the certificate
                          type: array
                          items:
                            type: string
                          minItems: 1
                        validityDuration:
                          description: Certificate validity duration, represented as a sequence of decimal numbers each with optional fraction and a unit suffix
                          type: string
                        secret:
                          description: Secret reference to store the certificate in
                          type: object
                          required:
                            - name
                            - namespace
                          properties:
                            name:
                              description: Name of the secret
                              type: string
                            namespace:
                              description: Namespace of the secret
                              type: string
                featureFlags:
                  description: FSM feature flags
                  type: object
                  properties:
                    enableEgressPolicy:
                      type: boolean
                    enableMulticlusterMode:
                      type: boolean
                      description: DEPRECATED, no longer used
                    enableSnapshotCacheMode:
                      type: boolean
                    enableAsyncProxyServiceMapping:
                      type: boolean
                    enableIngressBackendPolicy:
                      type: boolean
                    enableAccessControlPolicy:
                      type: boolean
                    enableAccessCertPolicy:
                      type: boolean
                    enableSidecarActiveHealthChecks:
                      type: boolean
                    enableRetryPolicy:
                      type: boolean
                    enablePluginPolicy:
                      type: boolean
                pluginChains:
                  description: Plugin Chains
                  type: object
                  properties:
                    inbound-tcp:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    inbound-http:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    outbound-tcp:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    outbound-http:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
    - name: v1alpha1
      served: true
      storage: false
      deprecated: true
      deprecationWarning: "config.flomesh.io/v1alpha1 MeshConfig is deprecated; use config.flomesh.io/v1alpha2 MeshConfig"
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                clusterSet:
                  description: Configuration for cluster
                  type: object
                  properties:
                    properties:
                      description: Configuration for cluster
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            description: Name defines the name of cluster property.
                            type: string
                          value:
                            description: Value defines the name of cluster property.
                            type: string
                sidecar:
                  description: Configuration for sidecar
                  type: object
                  properties:
                    enablePrivilegedInitContainer:
                      description: Enables privileged init containers for pods in mesh. When false, init containers only have NET_ADMIN.
                      type: boolean
                    logLevel:
                      description: Sets the logging verbosity of proxy sidecar, only applicable to newly created pods joining the mesh.
                      type: string
                      enum:
                        - trace
                        - debug
                        - info
                        - warning
                        - warn
                        - error
                        - critical
                        - off
                    maxDataPlaneConnections:
                      description: Max allowed data plane sidecar connections
                      type: integer
                    sidecarClass:
                      description: Class of the sidecar
                      type:
                        string
                    sidecarImage:
                      description: Image for the sidecar
                      type: string
                    initContainerImage:
                      description: Image for the init container
                      type: string
                    sidecarDrivers:
                      description: Drivers of sidecars supported by fsm
                      type: array
                      items:
                        type: object
                        required:
                          - sidecarName
                        properties:
                          sidecarName:
                            description: Name for the sidecar
                            type: string
                          sidecarImage:
                            description: Image for the sidecar
                            type: string
                          initContainerImage:
                            description: Image for the init container
                            type: string
                          proxyServerPort:
                            description: Remote destination port on which the Discovery Service listens for new connections from Sidecars.
                            type: integer
                            minimum: 1
                            maximum: 65535
                          sidecarDisabledMTLS:
                            description: Disabled mTLS
                            type: boolean
                    resources:
                      type: object
                      properties:
                        limits:
                          description: "Limits describes the maximum amount of compute resources allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/"
                          type: object
                          additionalProperties: true
                        requests:
                          description: "Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/"
                          type: object
                          additionalProperties: true
                    configResyncInterval:
                      description: Resync interval for regular proxy broadcast updates
                      type: string
                repoServer:
                  description: Configuration for RepoServer
                  type: object
                  required:
                    - ipaddr
                    - codebase
                  properties:
                    ipaddr:
                      description: IPAddr of the RepoServer.
                      type: string
                    codebase:
                      description: Codebase is the folder used by fsmController.
                      type: string
                traffic:
                  description: Configuration for traffic management
                  type: object
                  properties:
                    interceptionMode:
                      description: Traffic interception mode in the mesh
                      type: string
                      enum:
                        - iptables
                        - ebpf
                    enableEgress:
                      description: Enables egress in the mesh
                      type: boolean
                    outboundIPRangeExclusionList:
                      description: Global list of IP address ranges to exclude from outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: string
                        pattern: ((?:\d{1,3}\.){3}\d{1,3})\/(\d{1,2})$
                    outboundPortExclusionList:
                      description: Global list of ports to exclude from outbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: integer
                        minimum: 1
                        maximum: 65535
                    inboundPortExclusionList:
                      description: Global list of ports to exclude from inbound traffic interception by the sidecar proxy.
                      type: array
                      items:
                        type: integer
                        minimum: 1
                        maximum: 65535
                    enablePermissiveTrafficPolicyMode:
                      description: True for allowing traffic to flow between client and service pods within the mesh without SMI traffic policies, i.e. no traffic policy enforcement in the mesh. If set to false, enables deny-all traffic policy in mesh i.e. an SMI Traffic Target is necessary for services to communicate.
                      type: boolean
                    inboundExternalAuthorization:
                      description: Configures external authorization for inbound and ingress connections.
                      type: object
                      properties:
                        enable:
                          description: Enables/disables the inbound external authorization policy if present.
                          type: boolean
                        address:
                          description: Target destination endpoint that will handle external authorization.
                          type: string
                        port:
                          description: Remote destination port for the external authorization endpoint.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        statPrefix:
                          description: String prefix for inbound external authorization related metrics.
                          type: string
                          default: "inboundExtAuthz"
                        timeout:
                          description: Defines the timeout to consider for the remote endpoint to reply in time.
                          type: string
                          default: "1s"
                        failureModeAllow:
                          description: Allows specifying if traffic should succeed or fail if the external authorization endpoint fails to respond.
                          type: boolean
                observability:
                  description: Configuration for observing the service mesh, including metrics, logs, tracing etc,.
                  type: object
                  properties:
                    fsmLogLevel:
                      description: Allows setting FSM control plane log level at runtime
                      type: string
                    enableDebugServer:
                      description: Enables a debug endpoint on the fsm-controller pod to list information regarding the mesh such as proxy connections, certificates, and SMI policies.
                      type: boolean
                    tracing:
                      description: Configuration for distributed tracing
                      type: object
                      properties:
                        enable:
                          description: Enables Jaeger tracing for the mesh.
                          type: boolean
                        port:
                          description: Port on which tracing is enabled.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        address:
                          description: Address of Jaeger tracing deployment, if tracing is enabled.
                          type: string
                        endpoint:
                          description: Endpoint for tracing data, if tracing is enabled.
                          type: string
                        sampledFraction:
                          description: SampledFraction defines the sampled fraction.
                          type: string
                    remoteLogging:
                      description: Configuration for remote logging
                      type: object
                      properties:
                        enable:
                          description: Enables remote logging for the mesh.
                          type: boolean
                        port:
                          description: Port on which remote logging is enabled.
                          type: integer
                          minimum: 1
                          maximum: 65535
                        address:
                          description: Address of remote logging deployment, if remote logging is enabled.
                          type: string
                        endpoint:
                          description: Endpoint for tracing data, if remote logging is enabled.
                          type: string
                        authorization:
                          description: Authorization for remote logging service, if remote logging is enabled.
                          type: string
                        sampledFraction:
                          description: SampledFraction defines the sampled fraction.
                          type: string
                certificate:
                  description: Configuration for certificate management
                  type: object
                  required:
                    - serviceCertValidityDuration
                    - certKeyBitSize
                  properties:
                    serviceCertValidityDuration:
                      description: Sets the service certificate validity duration, represented as a sequence of decimal numbers each with optional fraction and a unit suffix.
                      type: string
                    certKeyBitSize:
                      description: Sets the certificate key bit size for data plane certificates.
                      type: integer
                    ingressGateway:
                      description: Configuration for the ingress gateway's certificate
                      type: object
                      required:
                        - subjectAltNames
                        - validityDuration
                        - secret
                      properties:
                        subjectAltNames:
                          description: Subject Alternative Names secured by the certificate
                          type: array
                          items:
                            type: string
                          minItems: 1
                        validityDuration:
                          description: Certificate validity duration, represented as a sequence of decimal numbers each with optional fraction and a unit suffix
                          type: string
                        secret:
                          description: Secret reference to store the certificate in
                          type: object
                          required:
                            - name
                            - namespace
                          properties:
                            name:
                              description: Name of the secret
                              type: string
                            namespace:
                              description: Namespace of the secret
                              type: string
                featureFlags:
                  description: FSM feature flags
                  type: object
                  properties:
                    enableEgressPolicy:
                      type: boolean
                    enableMulticlusterMode:
                      type: boolean
                    enableSnapshotCacheMode:
                      type: boolean
                    enableAsyncProxyServiceMapping:
                      type: boolean
                    enableIngressBackendPolicy:
                      type: boolean
                    enableAccessControlPolicy:
                      type: boolean
                    enableAccessCertPolicy:
                      type: boolean
                    enableSidecarActiveHealthChecks:
                      type: boolean
                    enableRetryPolicy:
                      type: boolean
                    enablePluginPolicy:
                      type: boolean
                pluginChains:
                  description: Plugin Chains
                  type: object
                  properties:
                    inbound-tcp:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    inbound-http:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    outbound-tcp:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean
                    outbound-http:
                      type: array
                      items:
                        type: object
                        required:
                          - plugin
                          - priority
                        properties:
                          plugin:
                            type: string
                          priority:
                            type: number
                          disable:
                            type: boolean